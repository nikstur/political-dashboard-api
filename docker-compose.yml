version: '3.7'
services:
  traefik:
    image: traefik:v2.3
    command:
      - '--api.insecure=true'
      - '--providers.docker'
      - '--providers.docker.exposedbydefault=false'
      - '--entrypoints.web.address=:80'
      - '--entrypoints.web.http.redirections.entryPoint.to=websecure'
      - '--entrypoints.web.http.redirections.entryPoint.scheme=https'
      - '--entrypoints.websecure.address=:443'
    ports:
      - 80:80
      - 443:443
      - 8080:8080
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
  ingester:
    build: ./ingester
    init: true
    command: initial
    depends_on:
      - db
  db:
    image: mongo:4.4
    init: true
    logging:
      driver: none
  api:
    build: ./api
    init: true
    depends_on:
      - ingester
      - db
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.api.rule=Host(`api.political-dashboard.localhost`)'
      - 'traefik.http.routers.api.tls=true'
      - 'traefik.http.routers.api.entrypoints=websecure'
